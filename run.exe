#! /bin/bash

######
nx=8
ny=8
nz=16
tr=7
######

thisfolder=$PWD
wheresource=$PWD/MODELES/
b1=32
b2=36
b1=3 # recompile with full if you changed this
b2=2 # recompile with full if you changed this

echo "*** COMPILATION GCM ***"
cd $wheresource/LMDZ.COMMON ; \rm gcm.e
makelmdz -cpp NODYN -d $nx"x"$ny"x"$nz -b $b1"x"$b2 -t $tr -s 1 -p generic -arch gfortran gcm > logcompilegcm 2> logcompilegcm
if [[ ! -f gcm.e ]] ; then 
  echo "Il y a eu un probleme. Voir : " $PWD/logcompilegcm ; exit
fi

echo "*** COMPILATION NEWSTART ***"
cd $wheresource/LMDZ.GENERIC ; \rm newstart.e
makegcm_gfortran_local -d $nx"x"$ny"x"$nz -debug newstart > logcompilerestart 2> logcompilerestart
if [[ ! -f newstart.e ]] ; then 
  echo "Il y a eu un probleme. Voir : " $PWD/logcompilenewstart ; exit
fi

echo "*** INITIALISATION ***"
cd $thisfolder/INIT ; \rm restartfi.nc restart.nc > /dev/null 2> /dev/null
./newstart.e < planet_start > log_newstart 2> log_newstart
if [[ ! -f restart.nc ]] ; then
  echo "Il y a eu un probleme. Voir : " $PWD/log_newstart ; exit 
fi

echo "*** SIMULATION ***"
cd $thisfolder/RUN ; \rm resultat.nc > /dev/null 2> /dev/null
time gcm.e | tee log_gcm | grep "Ls ="
mv diagfi.nc ../resultat.nc

echo "*** FIN ***"
